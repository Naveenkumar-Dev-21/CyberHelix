#!/usr/bin/env python3
"""
Automated Penetration Testing System Launcher
Complete agentic AI-powered penetration testing orchestrator
"""

import os
import sys
import asyncio
import argparse
from pathlib import Path

# Add src to Python path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

def banner():
    """Display system banner"""
    print("""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë              AUTOMATED PENETRATION TESTING                ‚ïë
‚ïë                    ORCHESTRATOR v1.0                     ‚ïë
‚ïë                                                           ‚ïë
‚ïë  ü§ñ AI-Powered ‚Ä¢ üîß Multi-Platform ‚Ä¢ üöÄ Autonomous        ‚ïë
‚ïë  üõ°Ô∏è  Network ‚Ä¢ üåê Web ‚Ä¢ üì± Mobile ‚Ä¢ ‚òÅÔ∏è  Cloud ‚Ä¢ üì° IoT    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
""")

async def run_agentic_assessment(targets, assessment_type="comprehensive"):
    """Run complete agentic AI assessment"""
    
    print(f"\nüöÄ Starting Agentic AI Penetration Testing...")
    print(f"üìã Assessment Type: {assessment_type}")
    print(f"üéØ Targets: {len(targets)}")
    
    try:
        # Import the agentic AI system
        from src.agentic_ai import AgenticPentestAI
        
        # Initialize the AI agent
        print("\nü§ñ Initializing AI Agent...")
        agent = AgenticPentestAI()
        
        results = []
        
        for i, target in enumerate(targets, 1):
            print(f"\n{'='*60}")
            print(f"üéØ ANALYZING TARGET {i}/{len(targets)}: {target}")
            print('='*60)
            
            # Generate intelligent request based on target
            if target.startswith(('http://', 'https://')):
                request = f"Perform comprehensive web application security assessment of {target}"
            elif target.endswith(('.apk', '.ipa')):
                request = f"Conduct mobile application security analysis of {target}"
            elif '/' in target:  # Network range
                request = f"Execute network penetration testing on {target}"
            else:
                request = f"Perform automated security assessment of {target}"
            
            # Process with agentic AI
            result = agent.process_request(request)
            results.append({
                'target': target,
                'result': result
            })
            
            # Display results
            print(f"\nüìä Assessment Results for {target}:")
            print(f"   ‚úÖ Success Rate: {result.get('success_rate', 0):.1%}")
            print(f"   üîÑ AI Iterations: {result.get('iterations', 0)}")
            print(f"   üß† Knowledge Gained: {len(result.get('knowledge_gained', []))} items")
            print(f"   üîß Adaptations: {len(result.get('adaptations', []))}")
            print(f"   ‚è±Ô∏è  Processing Time: {result.get('total_time', 0):.2f}s")
        
        # Final summary
        print(f"\n{'='*60}")
        print(f"üéâ AGENTIC AI ASSESSMENT COMPLETE!")
        print('='*60)
        
        total_knowledge = sum(len(r['result'].get('knowledge_gained', [])) for r in results)
        avg_success = sum(r['result'].get('success_rate', 0) for r in results) / len(results)
        total_time = sum(r['result'].get('total_time', 0) for r in results)
        
        print(f"üìà Overall Statistics:")
        print(f"   üéØ Targets Processed: {len(targets)}")
        print(f"   üöÄ Average Success Rate: {avg_success:.1%}")
        print(f"   üß† Total Knowledge Items: {total_knowledge}")
        print(f"   ‚è±Ô∏è  Total Processing Time: {total_time:.2f}s")
        
        # Agent status
        status = agent.get_status()
        print(f"\nü§ñ AI Agent Final Status:")
        print(f"   üìö Total Experiences: {status.get('memory_size', 0)}")
        print(f"   ‚úÖ Success Strategies: {status.get('success_strategies', 0)}")
        print(f"   üìà Learning Patterns: {status.get('learned_patterns', 0)}")
        
        return results
        
    except Exception as e:
        print(f"‚ùå Agentic assessment failed: {e}")
        return None

def run_specialized_assessment(target, platform="auto"):
    """Run platform-specific assessment"""
    
    print(f"\nüîß Running Specialized Assessment")
    print(f"üéØ Target: {target}")
    print(f"üè∑Ô∏è  Platform: {platform}")
    
    try:
        if platform == "network" or (platform == "auto" and any(c.isdigit() for c in target)):
            from src.network_assessor import NetworkAssessor
            assessor = NetworkAssessor()
            print("üåê Using Network Assessor")
            
        elif platform == "web" or (platform == "auto" and target.startswith(('http://', 'https://'))):
            from src.web_assessor import WebAssessor  
            assessor = WebAssessor()
            print("üåç Using Web Application Assessor")
            
        elif platform == "mobile" or (platform == "auto" and target.endswith(('.apk', '.ipa'))):
            from src.mobile_assessor import MobileAssessor
            assessor = MobileAssessor()
            print("üì± Using Mobile Application Assessor")
            
        elif platform == "wireless":
            from src.wireless_assessor import WirelessAssessor
            assessor = WirelessAssessor()
            print("üì° Using Wireless Security Assessor")
            
        elif platform == "cloud":
            from src.cloud_assessor import CloudAssessor
            assessor = CloudAssessor()
            print("‚òÅÔ∏è Using Cloud Security Assessor")
            
        elif platform == "iot":
            from src.iot_assessor import IoTAssessor
            assessor = IoTAssessor()
            print("üîå Using IoT Security Assessor")
            
        else:
            print("üîß Using Generic Network Assessor")
            from src.network_assessor import NetworkAssessor
            assessor = NetworkAssessor()
        
        print(f"‚úÖ {assessor.__class__.__name__} initialized successfully")
        print(f"üöÄ Assessment framework ready for {target}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Specialized assessment failed: {e}")
        return False

def run_ai_analysis(targets):
    """Run AI-driven analysis without full execution"""
    
    print(f"\nüß† Running AI Analysis Only")
    print(f"üéØ Analyzing {len(targets)} targets")
    
    try:
        # Import NLP processor for intelligent analysis
        from src.enhanced_nlp_processor import EnhancedNLPProcessor
        
        nlp = EnhancedNLPProcessor()
        
        for i, target in enumerate(targets, 1):
            print(f"\nüìä Target {i}: {target}")
            
            # Generate assessment request
            request = f"analyze security of {target}"
            intent = nlp.process_request(request)
            
            print(f"   üéØ Identified Intent: {intent.primary_command.value}")
            print(f"   üé™ Confidence: {intent.confidence:.2%}")
            print(f"   üè∑Ô∏è  Target Type: {', '.join(intent.targets) if intent.targets else 'Generic'}")
            print(f"   üîß Modifiers: {', '.join(intent.modifiers) if intent.modifiers else 'None'}")
            
            # Generate execution plan
            from src.enhanced_nlp_processor import create_enhanced_execution_plan
            plan = create_enhanced_execution_plan(request)
            
            print(f"   üìã Execution Plan: {len(plan['plan'])} steps")
            for j, step in enumerate(plan['plan'][:3], 1):  # Show first 3 steps
                print(f"      {j}. {step['module']} {' '.join(step['args'])}")
            
            if len(plan['plan']) > 3:
                print(f"      ... and {len(plan['plan']) - 3} more steps")
        
        print(f"\n‚úÖ AI Analysis Complete!")
        return True
        
    except Exception as e:
        print(f"‚ùå AI analysis failed: {e}")
        return False

def demo_mode():
    """Run comprehensive demo of the system"""
    
    print(f"\nüé™ DEMONSTRATION MODE")
    print("="*50)
    
    # Demo targets
    demo_targets = [
        "https://example.com",
        "192.168.1.100", 
        "vulnerable-app.apk",
        "10.0.0.0/24"
    ]
    
    print(f"üéØ Demo targets:")
    for i, target in enumerate(demo_targets, 1):
        print(f"   {i}. {target}")
    
    # Test different components
    print(f"\nüîß Testing System Components:")
    
    # 1. AI Analysis
    print(f"\n1Ô∏è‚É£ AI-Driven Analysis:")
    run_ai_analysis(demo_targets[:2])
    
    # 2. Specialized Assessment  
    print(f"\n2Ô∏è‚É£ Platform-Specific Assessment:")
    run_specialized_assessment(demo_targets[0], "web")
    
    # 3. Configuration Test
    print(f"\n3Ô∏è‚É£ Configuration System:")
    try:
        from src.config import Config
        config = Config()
        print("‚úÖ Configuration system loaded")
        print(f"   üìä Available settings: Multiple configuration options")
    except Exception as e:
        print(f"‚ö†Ô∏è  Configuration test: {e}")
    
    print(f"\nüéâ Demo complete! The system is fully operational.")

def main():
    """Main application entry point"""
    
    parser = argparse.ArgumentParser(
        description="Automated Penetration Testing Orchestrator",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  python autopentest_launcher.py --demo
  python autopentest_launcher.py --agentic --targets https://example.com 192.168.1.100
  python autopentest_launcher.py --analyze --targets target1 target2
  python autopentest_launcher.py --platform web --target https://example.com
        """
    )
    
    parser.add_argument('--demo', action='store_true', 
                       help='Run comprehensive system demonstration')
    parser.add_argument('--agentic', action='store_true',
                       help='Run full agentic AI assessment')
    parser.add_argument('--analyze', action='store_true',
                       help='Run AI analysis only (no execution)')
    parser.add_argument('--platform', choices=['network', 'web', 'mobile', 'wireless', 'cloud', 'iot'],
                       help='Specify platform for specialized assessment')
    parser.add_argument('--targets', nargs='+',
                       help='Target(s) for assessment')
    parser.add_argument('--target', 
                       help='Single target for platform-specific assessment')
    parser.add_argument('--version', action='version', version='AutoPentest v1.0.0')
    
    args = parser.parse_args()
    
    # Display banner
    banner()
    
    if args.demo:
        demo_mode()
        
    elif args.agentic and args.targets:
        asyncio.run(run_agentic_assessment(args.targets))
        
    elif args.analyze and args.targets:
        run_ai_analysis(args.targets)
        
    elif args.platform and args.target:
        run_specialized_assessment(args.target, args.platform)
        
    elif not any([args.demo, args.agentic, args.analyze, args.platform]):
        # Default: run demo
        print("üéØ No specific mode selected, running demonstration...")
        demo_mode()
        
    else:
        print("‚ùå Invalid argument combination. Use --help for usage information.")
        parser.print_help()

if __name__ == "__main__":
    main()
